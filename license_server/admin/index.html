<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDT License Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-tertiary: #1a1a24;
            --border-color: #2a2a3a; --text-primary: #f0f0f5; --text-secondary: #8888a0;
            --accent-blue: #4d9fff; --accent-green: #22c55e; --accent-red: #ef4444;
            --accent-yellow: #eab308; --accent-purple: #a855f7; --accent-cyan: #06b6d4;
            --accent-orange: #f97316;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%); }
        .login-box { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; padding: 48px; width: 100%; max-width: 440px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .login-box h1 { font-size: 24px; margin-bottom: 8px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .login-box > p { color: var(--text-secondary); text-align: center; margin-bottom: 32px; font-size: 14px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 10px; color: var(--text-primary); font-size: 14px; transition: all 0.2s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(77,159,255,0.15); }
        
        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-blue), #3b82f6); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(77,159,255,0.3); }
        .btn-success { background: linear-gradient(135deg, var(--accent-green), #16a34a); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--accent-red), #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--accent-yellow), #ca8a04); color: #000; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-sm { padding: 8px 14px; font-size: 12px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        
        /* Dashboard */
        .dashboard { display: none; }
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px 12px; display: flex; flex-direction: column; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; padding: 8px 12px 24px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .sidebar-logo i { font-size: 26px; color: var(--accent-blue); }
        .sidebar-logo span { font-size: 18px; font-weight: 700; }
        
        .nav-section { margin-bottom: 20px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); padding: 0 12px; margin-bottom: 8px; letter-spacing: 1px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; color: var(--text-secondary); cursor: pointer; margin-bottom: 4px; transition: all 0.2s; font-size: 14px; }
        .nav-item i { font-size: 18px; width: 22px; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: rgba(77,159,255,0.15); color: var(--accent-blue); }
        .nav-item .badge { margin-left: auto; background: var(--accent-blue); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .nav-item .badge.red { background: var(--accent-red); }
        .nav-item .badge.yellow { background: var(--accent-yellow); color: #000; }
        
        .sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color); }
        
        .main-content { margin-left: 260px; padding: 28px; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; }
        .page-header h1 { font-size: 26px; font-weight: 700; }
        .page-header-actions { display: flex; gap: 12px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 14px; padding: 20px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.blue::before { background: var(--accent-blue); }
        .stat-card.green::before { background: var(--accent-green); }
        .stat-card.red::before { background: var(--accent-red); }
        .stat-card.purple::before { background: var(--accent-purple); }
        .stat-card.yellow::before { background: var(--accent-yellow); }
        .stat-card.cyan::before { background: var(--accent-cyan); }
        .stat-card.orange::before { background: var(--accent-orange); }
        .stat-card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 14px; }
        .stat-card.blue .stat-card-icon { background: rgba(77,159,255,0.15); color: var(--accent-blue); }
        .stat-card.green .stat-card-icon { background: rgba(34,197,94,0.15); color: var(--accent-green); }
        .stat-card.red .stat-card-icon { background: rgba(239,68,68,0.15); color: var(--accent-red); }
        .stat-card.purple .stat-card-icon { background: rgba(168,85,247,0.15); color: var(--accent-purple); }
        .stat-card.yellow .stat-card-icon { background: rgba(234,179,8,0.15); color: var(--accent-yellow); }
        .stat-card.cyan .stat-card-icon { background: rgba(6,182,212,0.15); color: var(--accent-cyan); }
        .stat-card.orange .stat-card-icon { background: rgba(249,115,22,0.15); color: var(--accent-orange); }
        .stat-card .label { color: var(--text-secondary); font-size: 12px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        
        /* Tables */
        .table-container { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 14px; overflow: hidden; margin-bottom: 24px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; border-bottom: 1px solid var(--border-color); }
        .table-header h2 { font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); font-weight: 600; font-size: 11px; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; }
        tr:hover { background: rgba(255,255,255,0.02); }
        tr:last-child td { border-bottom: none; }
        
        .badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-active { background: rgba(34,197,94,0.15); color: var(--accent-green); }
        .badge-inactive, .badge-disabled { background: rgba(239,68,68,0.15); color: var(--accent-red); }
        .badge-expired { background: rgba(234,179,8,0.15); color: var(--accent-yellow); }
        .badge-visitor { background: rgba(77,159,255,0.15); color: var(--accent-blue); }
        .badge-suspicious { background: rgba(234,179,8,0.15); color: var(--accent-yellow); }
        .badge-hacking { background: rgba(249,115,22,0.15); color: var(--accent-orange); }
        .badge-banned { background: rgba(239,68,68,0.15); color: var(--accent-red); }
        .badge-standard { background: rgba(77,159,255,0.15); color: var(--accent-blue); }
        .badge-pro { background: rgba(168,85,247,0.15); color: var(--accent-purple); }
        .badge-enterprise { background: rgba(6,182,212,0.15); color: var(--accent-cyan); }
        .badge-lifetime { background: rgba(34,197,94,0.15); color: var(--accent-green); }
        
        .license-key { font-family: 'JetBrains Mono', 'Consolas', monospace; background: var(--bg-tertiary); padding: 5px 10px; border-radius: 6px; font-size: 12px; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s; }
        .license-key:hover { background: var(--border-color); }
        .app-id { font-family: 'JetBrains Mono', 'Consolas', monospace; background: rgba(168,85,247,0.15); color: var(--accent-purple); padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .app-id:hover { background: rgba(168,85,247,0.25); }
        .copyable { position: relative; }
        .copyable::after { content: 'ðŸ“‹'; margin-left: 6px; font-size: 10px; opacity: 0; transition: opacity 0.2s; }
        .copyable:hover::after { opacity: 1; }
        
        .actions { display: flex; gap: 6px; }
        
        /* Filters */
        .filters-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap; }
        .search-box { position: relative; flex: 1; max-width: 360px; min-width: 200px; }
        .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .search-box input { width: 100%; padding: 12px 16px 12px 42px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); }
        .filter-group { display: flex; gap: 10px; }
        .filter-group select { padding: 10px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); min-width: 130px; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; animation: modalIn 0.25s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 22px 26px; border-bottom: 1px solid var(--border-color); }
        .modal-header h2 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 22px; cursor: pointer; padding: 4px; border-radius: 6px; }
        .modal-close:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .modal-body { padding: 26px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 18px 26px; border-top: 1px solid var(--border-color); background: var(--bg-tertiary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .readonly { opacity: 0.6; cursor: not-allowed; }
        
        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 22px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .toast i { font-size: 20px; }
        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.success i { color: var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.error i { color: var(--accent-red); }
        .toast.info { border-left: 4px solid var(--accent-blue); }
        .toast.info i { color: var(--accent-blue); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .page-section { display: none; }
        .page-section.active { display: block; }
        
        /* License Detail Card */
        .license-detail-card { background: var(--bg-tertiary); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .license-detail-card h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .detail-item { padding: 12px; background: var(--bg-secondary); border-radius: 8px; }
        .detail-item label { display: block; font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
        .detail-item span { font-size: 14px; font-weight: 500; }
        
        /* User Card */
        .user-card { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
        .user-card-icon { width: 48px; height: 48px; border-radius: 12px; background: rgba(168,85,247,0.15); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--accent-purple); }
        .user-card-info { flex: 1; }
        .user-card-info h4 { font-size: 14px; margin-bottom: 4px; }
        .user-card-info p { font-size: 12px; color: var(--text-secondary); }
        
        /* Settings */
        .settings-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 14px; padding: 24px; margin-bottom: 20px; }
        .settings-card h3 { font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
        .settings-card p { color: var(--text-secondary); margin-bottom: 16px; font-size: 14px; }
        
        .status-msg { padding: 14px; border-radius: 10px; font-size: 13px; text-align: center; }
        .status-msg.error { background: rgba(239,68,68,0.15); color: var(--accent-red); }
        .status-msg.success { background: rgba(34,197,94,0.15); color: var(--accent-green); }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }
        
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { 
            .sidebar { display: none; } 
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .live-dot { width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; animation: pulse 2s infinite; }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Login -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1><i class="bi bi-shield-lock-fill"></i> VIDT Admin</h1>
            <p>Connect to Supabase to manage licenses</p>
            <div class="form-group">
                <label>Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
            </div>
            <div class="form-group">
                <label>Service Role Key</label>
                <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIs...">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="login()">
                <i class="bi bi-plug-fill"></i> Connect
            </button>
            <div id="statusMsg" class="status-msg" style="display:none;margin-top:16px;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="sidebar">
            <div class="sidebar-logo">
                <i class="bi bi-shield-lock-fill"></i>
                <span>VIDT Admin</span>
                <div id="liveIndicator" style="margin-left:auto;display:flex;align-items:center;gap:6px;font-size:11px;color:var(--accent-green);">
                    <span class="live-dot"></span>
                    LIVE
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <div class="nav-item active" onclick="showPage('overview', this)">
                    <i class="bi bi-grid-1x2-fill"></i> Dashboard
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <div class="nav-item" onclick="showPage('licenses', this)">
                    <i class="bi bi-key-fill"></i> Licenses
                    <span class="badge" id="navLicenseCount">0</span>
                </div>
                <div class="nav-item" onclick="showPage('users', this)">
                    <i class="bi bi-people-fill"></i> Users & Devices
                    <span class="badge" id="navUserCount">0</span>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Security</div>
                <div class="nav-item" onclick="showPage('suspicious', this)">
                    <i class="bi bi-exclamation-triangle-fill"></i> Suspicious
                    <span class="badge yellow" id="navSuspiciousCount">0</span>
                </div>
                <div class="nav-item" onclick="showPage('banned', this)">
                    <i class="bi bi-slash-circle-fill"></i> Banned
                    <span class="badge red" id="navBannedCount">0</span>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">System</div>
                <div class="nav-item" onclick="showPage('logs', this)">
                    <i class="bi bi-journal-text"></i> Activity Logs
                </div>
                <div class="nav-item" onclick="showPage('settings', this)">
                    <i class="bi bi-gear-fill"></i> Settings
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="nav-item" onclick="logout()" style="color: var(--accent-red);">
                    <i class="bi bi-box-arrow-left"></i> Disconnect
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Overview Page -->
            <div class="page-section active" id="page-overview">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary" onclick="loadAllData()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                        <button class="btn btn-primary" onclick="showModal('createModal')"><i class="bi bi-plus-lg"></i> New License</button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-card-icon"><i class="bi bi-key-fill"></i></div>
                        <div class="label">Total Licenses</div>
                        <div class="value" id="statTotal">0</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-card-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="label">Active Licenses</div>
                        <div class="value" id="statActive">0</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-card-icon"><i class="bi bi-pc-display"></i></div>
                        <div class="label">Active Devices</div>
                        <div class="value" id="statDevices">0</div>
                    </div>
                    <div class="stat-card cyan">
                        <div class="stat-card-icon"><i class="bi bi-person-check-fill"></i></div>
                        <div class="label">Licensed Users</div>
                        <div class="value" id="statLicensedUsers">0</div>
                    </div>
                </div>
                
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card yellow">
                        <div class="stat-card-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                        <div class="label">Suspicious</div>
                        <div class="value" id="statSuspicious">0</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-card-icon"><i class="bi bi-bug-fill"></i></div>
                        <div class="label">Hacking Attempts</div>
                        <div class="value" id="statHacking">0</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-card-icon"><i class="bi bi-slash-circle-fill"></i></div>
                        <div class="label">Banned</div>
                        <div class="value" id="statBanned">0</div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="table-container">
                    <div class="table-header">
                        <h2><i class="bi bi-clock-history"></i> Recent License Activity</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Customer</th>
                                <th>App ID (Device)</th>
                                <th>Status</th>
                                <th>Last Active</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Licenses Page -->
            <div class="page-section" id="page-licenses">
                <div class="page-header">
                    <h1>License Management</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary" onclick="exportLicenses()"><i class="bi bi-download"></i> Export</button>
                        <button class="btn btn-primary" onclick="showModal('createModal')"><i class="bi bi-plus-lg"></i> New License</button>
                    </div>
                </div>
                
                <div class="filters-bar">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="searchInput" placeholder="Search license, email, App ID..." oninput="filterLicenses()">
                    </div>
                    <div class="filter-group">
                        <select id="filterStatus" onchange="filterLicenses()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="disabled">Disabled</option>
                            <option value="expired">Expired</option>
                        </select>
                        <select id="filterType" onchange="filterLicenses()">
                            <option value="">All Types</option>
                            <option value="standard">Standard</option>
                            <option value="pro">Pro</option>
                            <option value="enterprise">Enterprise</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Devices (App IDs)</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="licenseTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Users Page -->
            <div class="page-section" id="page-users">
                <div class="page-header">
                    <h1>Users & Devices</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary" onclick="loadUsers()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                </div>
                
                <div class="filters-bar">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="userSearchInput" placeholder="Search App ID, IP, license..." oninput="filterUsers()">
                    </div>
                    <div class="filter-group">
                        <select id="filterUserStatus" onchange="filterUsers()">
                            <option value="">All Status</option>
                            <option value="active">Licensed</option>
                            <option value="visitor">Visitor (No License)</option>
                            <option value="suspicious">Suspicious</option>
                            <option value="hacking">Hacking</option>
                            <option value="banned">Banned</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>App ID</th>
                                <th>License Key</th>
                                <th>Status</th>
                                <th>Total Visits</th>
                                <th>Failed Attempts</th>
                                <th>Last IP</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Suspicious Page -->
            <div class="page-section" id="page-suspicious">
                <div class="page-header">
                    <h1><i class="bi bi-exclamation-triangle-fill" style="color:var(--accent-yellow);margin-right:12px;"></i> Suspicious Activity</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary" onclick="loadSuspicious()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>App ID</th>
                                <th>License</th>
                                <th>Status</th>
                                <th>Failed Attempts</th>
                                <th>Last IP</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suspiciousTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Banned Page -->
            <div class="page-section" id="page-banned">
                <div class="page-header">
                    <h1><i class="bi bi-slash-circle-fill" style="color:var(--accent-red);margin-right:12px;"></i> Banned Users</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary" onclick="loadBanned()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>App ID</th>
                                <th>License</th>
                                <th>Ban Reason</th>
                                <th>Banned At</th>
                                <th>Last IP</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bannedTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Logs Page -->
            <div class="page-section" id="page-logs">
                <div class="page-header">
                    <h1>Activity Logs</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary" onclick="loadLogs()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                        <button class="btn btn-danger" onclick="clearLogs()"><i class="bi bi-trash"></i> Clear Logs</button>
                    </div>
                </div>
                <div class="filters-bar">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="logSearchInput" placeholder="Search logs..." oninput="filterLogs()">
                    </div>
                    <div class="filter-group">
                        <select id="filterLogAction" onchange="filterLogs()">
                            <option value="">All Actions</option>
                            <option value="validate">Validate</option>
                            <option value="activate">Activate</option>
                            <option value="deactivate">Deactivate</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Action</th>
                                <th>License Key</th>
                                <th>App ID</th>
                                <th>IP Address</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div class="page-section" id="page-settings">
                <div class="page-header">
                    <h1>Settings</h1>
                </div>
                <div class="settings-card">
                    <h3><i class="bi bi-database-fill"></i> Database Connection</h3>
                    <p>Connected to: <strong id="connectedUrl"></strong></p>
                    <button class="btn btn-secondary" onclick="logout()"><i class="bi bi-plug"></i> Disconnect</button>
                </div>
                <div class="settings-card">
                    <h3><i class="bi bi-shield-fill"></i> Security Settings</h3>
                    <p>Configure automatic ban thresholds and suspicious activity detection.</p>
                    <div class="form-row" style="margin-top:16px;">
                        <div class="form-group">
                            <label>Failed attempts before suspicious</label>
                            <input type="number" id="suspiciousThreshold" value="3" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>Failed attempts before auto-ban</label>
                            <input type="number" id="banThreshold" value="10" min="1" max="50">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create License Modal -->
    <div class="modal-overlay" id="createModal" onclick="if(event.target===this)closeModal('createModal')">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="bi bi-plus-circle-fill"></i> Create License</h2>
                <button class="modal-close" onclick="closeModal('createModal')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newEmail" placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newName" placeholder="Customer Name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>License Type</label>
                        <select id="newType">
                            <option value="standard">Standard</option>
                            <option value="pro">Pro</option>
                            <option value="enterprise">Enterprise</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Devices</label>
                        <input type="number" id="newDevices" value="1" min="1" max="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Duration (days, 0 = lifetime)</label>
                        <input type="number" id="newDays" value="30" min="0">
                    </div>
                    <div class="form-group">
                        <label>Custom Message</label>
                        <input type="text" id="newMessage" placeholder="Welcome message">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes (internal)</label>
                    <textarea id="newNotes" rows="2" placeholder="Internal notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createModal')">Cancel</button>
                <button class="btn btn-success" onclick="createLicense()"><i class="bi bi-check-lg"></i> Create</button>
            </div>
        </div>
    </div>
    
    <!-- View License Modal -->
    <div class="modal-overlay" id="viewModal" onclick="if(event.target===this)closeModal('viewModal')">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="bi bi-key-fill"></i> License Details</h2>
                <button class="modal-close" onclick="closeModal('viewModal')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body" id="viewModalContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- User Action Modal -->
    <div class="modal-overlay" id="userModal" onclick="if(event.target===this)closeModal('userModal')">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="bi bi-person-gear"></i> User Action</h2>
                <button class="modal-close" onclick="closeModal('userModal')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>App ID</label>
                    <input type="text" id="userAppId" readonly class="readonly">
                </div>
                <div class="form-group">
                    <label>Set Status</label>
                    <select id="userStatus" onchange="toggleBanReason()">
                        <option value="active">Active (Licensed)</option>
                        <option value="visitor">Visitor</option>
                        <option value="suspicious">Suspicious</option>
                        <option value="hacking">Hacking</option>
                        <option value="banned">Banned</option>
                    </select>
                </div>
                <div class="form-group" id="banReasonGroup" style="display:none;">
                    <label>Ban Reason</label>
                    <textarea id="banReason" rows="2" placeholder="Reason for ban..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserStatus()"><i class="bi bi-check-lg"></i> Save</button>
            </div>
        </div>
    </div>
    
    <!-- Edit License Modal -->
    <div class="modal-overlay" id="editModal" onclick="if(event.target===this)closeModal('editModal')">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="bi bi-pencil-fill"></i> Edit License</h2>
                <button class="modal-close" onclick="closeModal('editModal')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editKey">
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editEmail">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="editName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>License Type</label>
                        <select id="editType">
                            <option value="standard">Standard</option>
                            <option value="pro">Pro</option>
                            <option value="enterprise">Enterprise</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Devices</label>
                        <input type="number" id="editDevices" min="1" max="100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Custom Message</label>
                    <input type="text" id="editMessage">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLicense()"><i class="bi bi-check-lg"></i> Save</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let SUPABASE_URL = '';
        let SUPABASE_KEY = '';
        let allLicenses = [];
        let allUsers = [];
        let allActivations = [];
        let allLogs = [];
        let realtimeChannel = null;
        let autoRefreshInterval = null;
        
        // Toast notification
        function toast(msg, type = 'success') {
            const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', info: 'bi-info-circle-fill' };
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.innerHTML = `<i class="bi ${icons[type]}"></i><span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }
        
        // Copy to clipboard
        function copyToClipboard(text, label = 'Copied') {
            navigator.clipboard.writeText(text).then(() => {
                toast(`${label}: ${text}`, 'info');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                toast(`${label}: ${text}`, 'info');
            });
        }
        
        // API helper
        async function api(method, table, data = null, filters = {}) {
            let url = `${SUPABASE_URL}/rest/v1/${table}`;
            if (!table.includes('?')) {
                const params = new URLSearchParams();
                for (const [k, v] of Object.entries(filters)) params.append(k, `eq.${v}`);
                if (params.toString()) url += '?' + params.toString();
            }
            
            const opts = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                }
            };
            if (data) opts.body = JSON.stringify(data);
            
            const res = await fetch(url, opts);
            if (!res.ok) throw new Error(await res.text());
            const text = await res.text();
            return text ? JSON.parse(text) : [];
        }
        
        // ============ REAL-TIME UPDATES ============
        
        function startRealtime() {
            // Start auto-refresh every 5 seconds for real-time feel
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                loadAllDataSilent();
            }, 5000);
            
            // Also try WebSocket for instant updates
            connectRealtimeWebSocket();
        }
        
        function stopRealtime() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (realtimeChannel) {
                realtimeChannel.close();
                realtimeChannel = null;
            }
        }
        
        function connectRealtimeWebSocket() {
            try {
                const wsUrl = SUPABASE_URL.replace('https://', 'wss://').replace('http://', 'ws://');
                const ws = new WebSocket(`${wsUrl}/realtime/v1/websocket?apikey=${SUPABASE_KEY}&vsn=1.0.0`);
                
                ws.onopen = () => {
                    console.log('Realtime connected');
                    // Subscribe to all tables
                    const subscribeMsg = {
                        topic: "realtime:public:*",
                        event: "phx_join",
                        payload: { config: { broadcast: { self: true } } },
                        ref: "1"
                    };
                    ws.send(JSON.stringify(subscribeMsg));
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.event === 'INSERT' || data.event === 'UPDATE' || data.event === 'DELETE') {
                            console.log('Realtime update:', data.event);
                            loadAllDataSilent();
                        }
                    } catch (e) {}
                };
                
                ws.onclose = () => {
                    console.log('Realtime disconnected, reconnecting in 5s...');
                    setTimeout(connectRealtimeWebSocket, 5000);
                };
                
                ws.onerror = () => {
                    // Silently fail, auto-refresh will handle updates
                };
                
                realtimeChannel = ws;
            } catch (e) {
                console.log('WebSocket not available, using polling');
            }
        }
        
        async function loadAllDataSilent() {
            // Silent refresh without toast
            try {
                allLicenses = await api('GET', 'licenses?order=created_at.desc');
                allActivations = await api('GET', 'activations?order=activated_at.desc');
                try { allUsers = await api('GET', 'users?order=last_seen.desc'); } catch(e) { allUsers = []; }
                
                updateStats();
                updateNavBadges();
                
                // Update current page
                const activePage = document.querySelector('.page-section.active');
                if (activePage) {
                    const pageId = activePage.id;
                    if (pageId === 'page-overview') renderRecentActivity();
                    if (pageId === 'page-licenses') renderLicenses(allLicenses);
                    if (pageId === 'page-users') renderUsers(allUsers);
                    if (pageId === 'page-suspicious') renderSuspicious(allUsers.filter(u => u.status === 'suspicious' || u.status === 'hacking'));
                    if (pageId === 'page-banned') renderBanned(allUsers.filter(u => u.status === 'banned'));
                }
            } catch (e) {
                // Silent fail
            }
        }
        
        // Login
        async function login() {
            SUPABASE_URL = document.getElementById('supabaseUrl').value.trim();
            SUPABASE_KEY = document.getElementById('supabaseKey').value.trim();
            
            if (!SUPABASE_URL || !SUPABASE_KEY) {
                showStatus('Please fill in all fields', true);
                return;
            }
            
            try {
                await api('GET', 'licenses?limit=1');
                localStorage.setItem('sb_config', JSON.stringify({ url: SUPABASE_URL, key: SUPABASE_KEY }));
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('connectedUrl').textContent = SUPABASE_URL;
                loadAllData();
                startRealtime();
                toast('Connected successfully!');
            } catch (e) {
                showStatus('Connection failed: ' + e.message, true);
            }
        }
        
        function showStatus(msg, isError = false) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'status-msg ' + (isError ? 'error' : 'success');
            el.style.display = 'block';
        }
        
        function logout() {
            stopRealtime();
            localStorage.removeItem('sb_config');
            location.reload();
        }
        
        // Auto-login
        window.onload = function() {
            const saved = localStorage.getItem('sb_config');
            if (saved) {
                const { url, key } = JSON.parse(saved);
                document.getElementById('supabaseUrl').value = url;
                document.getElementById('supabaseKey').value = key;
                login();
            }
        };
        
        // Navigation
        function showPage(page, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            
            if (page === 'licenses') loadLicenses();
            if (page === 'users') loadUsers();
            if (page === 'suspicious') loadSuspicious();
            if (page === 'banned') loadBanned();
            if (page === 'logs') loadLogs();
        }
        
        // Modal helpers
        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // Load all data
        async function loadAllData() {
            try {
                allLicenses = await api('GET', 'licenses?order=created_at.desc');
                allActivations = await api('GET', 'activations?order=activated_at.desc');
                try { allUsers = await api('GET', 'users?order=last_seen.desc'); } catch(e) { allUsers = []; }
                
                updateStats();
                renderRecentActivity();
                updateNavBadges();
            } catch (e) {
                console.error(e);
                toast('Failed to load data', 'error');
            }
        }
        
        function updateStats() {
            const total = allLicenses.length;
            const active = allLicenses.filter(l => l.active).length;
            const devices = allActivations.length;
            // Count users with a license key (regardless of status, except banned)
            const licensedUsers = allUsers.filter(u => u.license_key && u.status !== 'banned').length;
            const suspicious = allUsers.filter(u => u.status === 'suspicious').length;
            const hacking = allUsers.filter(u => u.status === 'hacking').length;
            const banned = allUsers.filter(u => u.status === 'banned').length;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statDevices').textContent = devices;
            document.getElementById('statLicensedUsers').textContent = licensedUsers;
            document.getElementById('statSuspicious').textContent = suspicious;
            document.getElementById('statHacking').textContent = hacking;
            document.getElementById('statBanned').textContent = banned;
        }
        
        function updateNavBadges() {
            document.getElementById('navLicenseCount').textContent = allLicenses.length;
            document.getElementById('navUserCount').textContent = allUsers.length;
            document.getElementById('navSuspiciousCount').textContent = allUsers.filter(u => u.status === 'suspicious' || u.status === 'hacking').length;
            document.getElementById('navBannedCount').textContent = allUsers.filter(u => u.status === 'banned').length;
        }
        
        // Helper functions
        function getLicenseActivations(licenseKey) {
            return allActivations.filter(a => a.license_key === licenseKey);
        }
        
        function getUserByAppId(appId) {
            return allUsers.find(u => u.app_id === appId);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString();
        }
        
        function formatShortDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString();
        }
        
        // Recent Activity
        function renderRecentActivity() {
            const rows = allLicenses.slice(0, 10).map(l => {
                const activations = getLicenseActivations(l.key);
                const appIds = activations.map(a => a.app_id).filter(Boolean);
                const appIdDisplay = appIds.length > 0 
                    ? appIds.slice(0, 2).map(id => `<span class="app-id" onclick="viewUser('${id}')">${id.slice(0,8)}...</span>`).join(' ') + (appIds.length > 2 ? ` <span style="color:var(--text-secondary);font-size:11px;">+${appIds.length - 2}</span>` : '')
                    : '<span style="color:var(--text-secondary)">No devices</span>';
                
                const isExpired = l.expires_at && new Date(l.expires_at) < new Date();
                const status = !l.active ? 'inactive' : isExpired ? 'expired' : 'active';
                const statusText = !l.active ? 'Disabled' : isExpired ? 'Expired' : 'Active';
                
                return `<tr>
                    <td><span class="license-key" style="cursor:pointer;" onclick="viewLicense('${l.key}')">${l.key}</span></td>
                    <td>${l.name || l.email || '-'}</td>
                    <td>${appIdDisplay}</td>
                    <td><span class="badge badge-${status}">${statusText}</span></td>
                    <td>${formatDate(l.last_seen)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('recentActivityTable').innerHTML = rows || '<tr><td colspan="5"><div class="empty-state"><i class="bi bi-inbox"></i><p>No licenses yet</p></div></td></tr>';
        }
        
        // Licenses
        async function loadLicenses() {
            try {
                allLicenses = await api('GET', 'licenses?order=created_at.desc');
                allActivations = await api('GET', 'activations?order=activated_at.desc');
                renderLicenses(allLicenses);
            } catch (e) {
                toast('Failed to load licenses', 'error');
            }
        }
        
        function renderLicenses(list) {
            const now = new Date();
            const rows = list.map(l => {
                const activations = getLicenseActivations(l.key);
                const appIds = activations.map(a => a.app_id).filter(Boolean);
                const deviceCount = (l.bound_machines || []).length;
                
                let appIdDisplay = '';
                if (appIds.length > 0) {
                    appIdDisplay = `<div style="display:flex;flex-wrap:wrap;gap:4px;">`;
                    appIds.slice(0, 3).forEach(id => {
                        appIdDisplay += `<span class="app-id" title="Click to copy: ${id}" onclick="copyToClipboard('${id}', 'App ID copied')">${id.slice(0,8)}</span>`;
                    });
                    if (appIds.length > 3) appIdDisplay += `<span style="color:var(--text-secondary);font-size:11px;align-self:center;">+${appIds.length - 3}</span>`;
                    appIdDisplay += `</div>`;
                } else {
                    appIdDisplay = `<span style="color:var(--text-secondary);font-size:12px;">${deviceCount}/${l.max_machines || 1} devices</span>`;
                }
                
                const isActive = l.active;
                const isExpired = l.expires_at && new Date(l.expires_at) < now;
                const status = !isActive ? 'disabled' : isExpired ? 'expired' : 'active';
                const statusText = !isActive ? 'Disabled' : isExpired ? 'Expired' : 'Active';
                const typeClass = l.license_type || 'standard';
                
                return `<tr>
                    <td>
                        <span class="license-key copyable" title="Click to copy" onclick="copyToClipboard('${l.key}', 'License copied')">${l.key}</span>
                    </td>
                    <td>
                        <div style="font-weight:500;">${l.name || '-'}</div>
                        <div style="font-size:11px;color:var(--text-secondary);">${l.email || ''}</div>
                    </td>
                    <td><span class="badge badge-${typeClass}">${l.license_type || 'standard'}</span></td>
                    <td>${appIdDisplay}</td>
                    <td><span class="badge badge-${status}">${statusText}</span></td>
                    <td>${l.expires_at ? formatShortDate(l.expires_at) : '<span style="color:var(--accent-green)">Lifetime</span>'}</td>
                    <td class="actions">
                        <button class="btn btn-icon btn-secondary" onclick="copyToClipboard('${l.key}', 'License copied')" title="Copy"><i class="bi bi-clipboard"></i></button>
                        <button class="btn btn-icon btn-secondary" onclick="viewLicense('${l.key}')" title="View"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-icon btn-secondary" onclick="editLicense('${l.key}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-icon btn-secondary" onclick="toggleLicense('${l.key}', ${isActive})" title="${isActive ? 'Disable' : 'Enable'}"><i class="bi bi-${isActive ? 'pause' : 'play'}-circle"></i></button>
                        <button class="btn btn-icon btn-secondary" onclick="resetDevices('${l.key}')" title="Reset Devices"><i class="bi bi-arrow-counterclockwise"></i></button>
                        <button class="btn btn-icon btn-danger" onclick="deleteLicense('${l.key}')" title="Delete"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            
            document.getElementById('licenseTable').innerHTML = rows || '<tr><td colspan="7"><div class="empty-state"><i class="bi bi-key"></i><p>No licenses found</p></div></td></tr>';
        }
        
        function filterLicenses() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterType').value;
            const now = new Date();
            
            const filtered = allLicenses.filter(l => {
                const activations = getLicenseActivations(l.key);
                const appIds = activations.map(a => a.app_id || '').join(' ').toLowerCase();
                const matchSearch = !q || l.key.toLowerCase().includes(q) || (l.email || '').toLowerCase().includes(q) || (l.name || '').toLowerCase().includes(q) || appIds.includes(q);
                
                const isExpired = l.expires_at && new Date(l.expires_at) < now;
                const licStatus = !l.active ? 'disabled' : isExpired ? 'expired' : 'active';
                const matchStatus = !status || licStatus === status;
                const matchType = !type || (l.license_type || 'standard') === type;
                
                return matchSearch && matchStatus && matchType;
            });
            renderLicenses(filtered);
        }

        // View License
        function viewLicense(key) {
            const lic = allLicenses.find(l => l.key === key);
            if (!lic) return;
            
            const activations = getLicenseActivations(key);
            const isExpired = lic.expires_at && new Date(lic.expires_at) < new Date();
            const status = !lic.active ? 'Disabled' : isExpired ? 'Expired' : 'Active';
            
            let usersHtml = '';
            if (activations.length > 0) {
                usersHtml = `<div class="license-detail-card">
                    <h3><i class="bi bi-pc-display"></i> Connected Devices (${activations.length})</h3>`;
                activations.forEach(a => {
                    const user = getUserByAppId(a.app_id);
                    const userStatus = user ? user.status : 'unknown';
                    usersHtml += `
                    <div class="user-card">
                        <div class="user-card-icon"><i class="bi bi-pc-display"></i></div>
                        <div class="user-card-info">
                            <h4><span class="app-id" onclick="viewUser('${a.app_id}')">${a.app_id || 'Unknown'}</span></h4>
                            <p>IP: ${a.ip || '-'} â€¢ Version: ${a.app_version || '-'} â€¢ ${formatDate(a.activated_at)}</p>
                        </div>
                        <span class="badge badge-${userStatus}">${userStatus}</span>
                    </div>`;
                });
                usersHtml += '</div>';
            } else {
                usersHtml = `<div class="license-detail-card">
                    <h3><i class="bi bi-pc-display"></i> Connected Devices</h3>
                    <div class="empty-state" style="padding:30px;"><i class="bi bi-pc-display" style="font-size:32px;"></i><p>No devices connected yet</p></div>
                </div>`;
            }
            
            document.getElementById('viewModalContent').innerHTML = `
                <div class="license-detail-card">
                    <h3><i class="bi bi-key-fill"></i> License Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item" style="grid-column: span 2;">
                            <label>License Key</label>
                            <span class="license-key" style="font-size:14px;">${lic.key}</span>
                        </div>
                        <div class="detail-item">
                            <label>Status</label>
                            <span class="badge badge-${status.toLowerCase()}">${status}</span>
                        </div>
                        <div class="detail-item">
                            <label>Type</label>
                            <span class="badge badge-${lic.license_type || 'standard'}">${lic.license_type || 'standard'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Customer</label>
                            <span>${lic.name || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${lic.email || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Max Devices</label>
                            <span>${lic.max_machines || 1}</span>
                        </div>
                        <div class="detail-item">
                            <label>Expires</label>
                            <span>${lic.expires_at ? formatShortDate(lic.expires_at) : 'Never (Lifetime)'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Created</label>
                            <span>${formatDate(lic.created_at)}</span>
                        </div>
                        <div class="detail-item">
                            <label>Last Seen</label>
                            <span>${formatDate(lic.last_seen)}</span>
                        </div>
                    </div>
                    ${lic.notes ? `<div style="margin-top:12px;padding:12px;background:var(--bg-secondary);border-radius:8px;"><label style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;">Notes</label><p style="margin-top:4px;font-size:13px;">${lic.notes}</p></div>` : ''}
                </div>
                ${usersHtml}
            `;
            showModal('viewModal');
        }
        
        // Create License
        async function createLicense() {
            const email = document.getElementById('newEmail').value.trim();
            const name = document.getElementById('newName').value.trim();
            const type = document.getElementById('newType').value;
            const maxDevices = parseInt(document.getElementById('newDevices').value) || 1;
            const days = parseInt(document.getElementById('newDays').value);
            const message = document.getElementById('newMessage').value.trim();
            const notes = document.getElementById('newNotes').value.trim();
            
            const key = generateLicenseKey();
            const expiresAt = days > 0 ? new Date(Date.now() + days * 86400000).toISOString() : null;
            
            try {
                await api('POST', 'licenses', {
                    key,
                    email: email || null,
                    name: name || null,
                    license_type: type,
                    max_machines: maxDevices,
                    expires_at: expiresAt,
                    custom_message: message || null,
                    notes: notes || null,
                    active: true,
                    bound_machines: []
                });
                
                closeModal('createModal');
                toast('License created: ' + key);
                loadAllData();
                
                // Clear form
                document.getElementById('newEmail').value = '';
                document.getElementById('newName').value = '';
                document.getElementById('newType').value = 'standard';
                document.getElementById('newDevices').value = '1';
                document.getElementById('newDays').value = '30';
                document.getElementById('newMessage').value = '';
                document.getElementById('newNotes').value = '';
            } catch (e) {
                toast('Failed to create license: ' + e.message, 'error');
            }
        }
        
        function generateLicenseKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const segments = [];
            for (let i = 0; i < 4; i++) {
                let seg = '';
                for (let j = 0; j < 4; j++) seg += chars[Math.floor(Math.random() * chars.length)];
                segments.push(seg);
            }
            return segments.join('-');
        }
        
        // Edit License
        function editLicense(key) {
            const lic = allLicenses.find(l => l.key === key);
            if (!lic) return;
            
            document.getElementById('editKey').value = key;
            document.getElementById('editEmail').value = lic.email || '';
            document.getElementById('editName').value = lic.name || '';
            document.getElementById('editType').value = lic.license_type || 'standard';
            document.getElementById('editDevices').value = lic.max_machines || 1;
            document.getElementById('editMessage').value = lic.custom_message || '';
            document.getElementById('editNotes').value = lic.notes || '';
            
            showModal('editModal');
        }
        
        async function saveLicense() {
            const key = document.getElementById('editKey').value;
            
            try {
                await api('PATCH', `licenses?key=eq.${key}`, {
                    email: document.getElementById('editEmail').value || null,
                    name: document.getElementById('editName').value || null,
                    license_type: document.getElementById('editType').value,
                    max_machines: parseInt(document.getElementById('editDevices').value) || 1,
                    custom_message: document.getElementById('editMessage').value || null,
                    notes: document.getElementById('editNotes').value || null
                });
                
                closeModal('editModal');
                toast('License updated');
                loadAllData();
            } catch (e) {
                toast('Failed to update license: ' + e.message, 'error');
            }
        }
        
        // Toggle License
        async function toggleLicense(key, currentActive) {
            if (!confirm(`${currentActive ? 'Disable' : 'Enable'} this license?`)) return;
            
            try {
                await api('PATCH', `licenses?key=eq.${key}`, { active: !currentActive });
                toast(`License ${currentActive ? 'disabled' : 'enabled'}`);
                loadAllData();
            } catch (e) {
                toast('Failed to update license', 'error');
            }
        }
        
        // Reset Devices
        async function resetDevices(key) {
            if (!confirm('Reset all device activations for this license?')) return;
            
            try {
                await api('PATCH', `licenses?key=eq.${key}`, { bound_machines: [] });
                await api('DELETE', `activations?license_key=eq.${key}`);
                toast('Devices reset');
                loadAllData();
            } catch (e) {
                toast('Failed to reset devices', 'error');
            }
        }
        
        // Delete License
        async function deleteLicense(key) {
            if (!confirm('Delete this license? This cannot be undone.')) return;
            
            try {
                await api('DELETE', `activations?license_key=eq.${key}`);
                await api('DELETE', `licenses?key=eq.${key}`);
                toast('License deleted');
                loadAllData();
            } catch (e) {
                toast('Failed to delete license', 'error');
            }
        }
        
        // Export Licenses
        function exportLicenses() {
            const csv = ['Key,Email,Name,Type,Max Devices,Status,Expires,Created'];
            allLicenses.forEach(l => {
                const isExpired = l.expires_at && new Date(l.expires_at) < new Date();
                const status = !l.active ? 'Disabled' : isExpired ? 'Expired' : 'Active';
                csv.push(`${l.key},${l.email || ''},${l.name || ''},${l.license_type || 'standard'},${l.max_machines || 1},${status},${l.expires_at || 'Lifetime'},${l.created_at}`);
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'licenses_export.csv';
            a.click();
            URL.revokeObjectURL(url);
            toast('Licenses exported');
        }

        // Users
        async function loadUsers() {
            try {
                allUsers = await api('GET', 'users?order=last_seen.desc');
                allActivations = await api('GET', 'activations?order=activated_at.desc');
                renderUsers(allUsers);
            } catch (e) {
                toast('Failed to load users', 'error');
            }
        }
        
        function renderUsers(list) {
            const rows = list.map(u => {
                const statusClass = u.status || 'visitor';
                return `<tr>
                    <td><span class="app-id copyable" onclick="copyToClipboard('${u.app_id}', 'App ID copied')" title="Click to copy">${u.app_id}</span></td>
                    <td>${u.license_key ? `<span class="license-key copyable" onclick="copyToClipboard('${u.license_key}', 'License copied')" title="Click to copy">${u.license_key}</span>` : '<span style="color:var(--text-secondary)">None</span>'}</td>
                    <td><span class="badge badge-${statusClass}">${u.status || 'visitor'}</span></td>
                    <td>${u.total_visits || 0}</td>
                    <td>${u.failed_attempts || 0}</td>
                    <td>${u.last_ip || '-'}</td>
                    <td>${formatDate(u.last_seen)}</td>
                    <td class="actions">
                        <button class="btn btn-icon btn-secondary" onclick="showUserModal('${u.app_id}')" title="Edit Status"><i class="bi bi-pencil"></i></button>
                        ${u.status === 'banned' ? `<button class="btn btn-icon btn-success" onclick="unbanUser('${u.app_id}')" title="Unban"><i class="bi bi-check-circle"></i></button>` : `<button class="btn btn-icon btn-warning" onclick="banUser('${u.app_id}')" title="Ban"><i class="bi bi-slash-circle"></i></button>`}
                        <button class="btn btn-icon btn-danger" onclick="deleteUser('${u.app_id}')" title="Delete"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            
            document.getElementById('userTable').innerHTML = rows || '<tr><td colspan="8"><div class="empty-state"><i class="bi bi-people"></i><p>No users found</p></div></td></tr>';
        }
        
        function filterUsers() {
            const q = document.getElementById('userSearchInput').value.toLowerCase();
            const status = document.getElementById('filterUserStatus').value;
            
            const filtered = allUsers.filter(u => {
                const matchSearch = !q || u.app_id.toLowerCase().includes(q) || (u.license_key || '').toLowerCase().includes(q) || (u.last_ip || '').toLowerCase().includes(q);
                const matchStatus = !status || u.status === status;
                return matchSearch && matchStatus;
            });
            renderUsers(filtered);
        }
        
        function viewUser(appId) {
            const user = allUsers.find(u => u.app_id === appId);
            if (!user) {
                toast('User not found', 'info');
                return;
            }
            
            const activation = allActivations.find(a => a.app_id === appId);
            
            document.getElementById('viewModalContent').innerHTML = `
                <div class="license-detail-card">
                    <h3><i class="bi bi-person-fill"></i> User Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item" style="grid-column: span 2;">
                            <label>App ID</label>
                            <span class="app-id">${user.app_id}</span>
                        </div>
                        <div class="detail-item">
                            <label>Status</label>
                            <span class="badge badge-${user.status || 'visitor'}">${user.status || 'visitor'}</span>
                        </div>
                        <div class="detail-item">
                            <label>License</label>
                            <span>${user.license_key ? `<span class="license-key">${user.license_key}</span>` : 'None'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Total Visits</label>
                            <span>${user.total_visits || 0}</span>
                        </div>
                        <div class="detail-item">
                            <label>Failed Attempts</label>
                            <span style="color:${(user.failed_attempts || 0) > 3 ? 'var(--accent-red)' : 'inherit'}">${user.failed_attempts || 0}</span>
                        </div>
                        <div class="detail-item">
                            <label>Last IP</label>
                            <span>${user.last_ip || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Last Seen</label>
                            <span>${formatDate(user.last_seen)}</span>
                        </div>
                        <div class="detail-item">
                            <label>First Seen</label>
                            <span>${formatDate(user.first_seen)}</span>
                        </div>
                        <div class="detail-item">
                            <label>App Version</label>
                            <span>${activation?.app_version || '-'}</span>
                        </div>
                    </div>
                    ${user.ban_reason ? `<div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;border:1px solid var(--accent-red);"><label style="font-size:10px;color:var(--accent-red);text-transform:uppercase;">Ban Reason</label><p style="margin-top:4px;font-size:13px;color:var(--accent-red);">${user.ban_reason}</p></div>` : ''}
                </div>
            `;
            showModal('viewModal');
        }
        
        // User Status Modal
        function showUserModal(appId) {
            const user = allUsers.find(u => u.app_id === appId);
            if (!user) return;
            
            document.getElementById('userAppId').value = appId;
            document.getElementById('userStatus').value = user.status || 'visitor';
            document.getElementById('banReason').value = user.ban_reason || '';
            toggleBanReason();
            showModal('userModal');
        }
        
        function toggleBanReason() {
            const status = document.getElementById('userStatus').value;
            document.getElementById('banReasonGroup').style.display = status === 'banned' ? 'block' : 'none';
        }
        
        async function saveUserStatus() {
            const appId = document.getElementById('userAppId').value;
            const status = document.getElementById('userStatus').value;
            const banReason = document.getElementById('banReason').value;
            
            try {
                const data = { status };
                if (status === 'banned') {
                    data.ban_reason = banReason || 'Banned by admin';
                    data.banned_at = new Date().toISOString();
                } else {
                    data.ban_reason = null;
                    data.banned_at = null;
                }
                
                await api('PATCH', `users?app_id=eq.${appId}`, data);
                closeModal('userModal');
                toast('User status updated');
                loadAllData();
            } catch (e) {
                toast('Failed to update user', 'error');
            }
        }
        
        async function banUser(appId) {
            const reason = prompt('Ban reason:');
            if (reason === null) return;
            
            try {
                await api('PATCH', `users?app_id=eq.${appId}`, {
                    status: 'banned',
                    ban_reason: reason || 'Banned by admin',
                    banned_at: new Date().toISOString()
                });
                toast('User banned');
                loadAllData();
            } catch (e) {
                toast('Failed to ban user', 'error');
            }
        }
        
        async function unbanUser(appId) {
            if (!confirm('Unban this user?')) return;
            
            try {
                await api('PATCH', `users?app_id=eq.${appId}`, {
                    status: 'visitor',
                    ban_reason: null,
                    banned_at: null,
                    failed_attempts: 0
                });
                toast('User unbanned');
                loadAllData();
            } catch (e) {
                toast('Failed to unban user', 'error');
            }
        }
        
        async function deleteUser(appId) {
            if (!confirm('Delete this user? This will remove all their data.')) return;
            
            try {
                // Delete from activations first
                await api('DELETE', `activations?app_id=eq.${appId}`);
                // Delete from users
                await api('DELETE', `users?app_id=eq.${appId}`);
                toast('User deleted');
                loadAllData();
            } catch (e) {
                toast('Failed to delete user', 'error');
            }
        }
        
        // Suspicious
        async function loadSuspicious() {
            try {
                allUsers = await api('GET', 'users?order=last_seen.desc');
                const suspicious = allUsers.filter(u => u.status === 'suspicious' || u.status === 'hacking');
                renderSuspicious(suspicious);
            } catch (e) {
                toast('Failed to load suspicious users', 'error');
            }
        }
        
        function renderSuspicious(list) {
            const rows = list.map(u => `<tr>
                <td><span class="app-id" onclick="viewUser('${u.app_id}')">${u.app_id}</span></td>
                <td>${u.license_key ? `<span class="license-key">${u.license_key}</span>` : '-'}</td>
                <td><span class="badge badge-${u.status}">${u.status}</span></td>
                <td style="color:var(--accent-red);font-weight:600;">${u.failed_attempts || 0}</td>
                <td>${u.last_ip || '-'}</td>
                <td>${formatDate(u.last_seen)}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-success" onclick="clearSuspicious('${u.app_id}')"><i class="bi bi-check-lg"></i> Clear</button>
                    <button class="btn btn-sm btn-danger" onclick="banUser('${u.app_id}')"><i class="bi bi-slash-circle"></i> Ban</button>
                </td>
            </tr>`).join('');
            
            document.getElementById('suspiciousTable').innerHTML = rows || '<tr><td colspan="7"><div class="empty-state"><i class="bi bi-shield-check"></i><p>No suspicious activity detected</p></div></td></tr>';
        }
        
        async function clearSuspicious(appId) {
            try {
                await api('PATCH', `users?app_id=eq.${appId}`, {
                    status: 'visitor',
                    failed_attempts: 0
                });
                toast('User cleared');
                loadSuspicious();
                updateNavBadges();
            } catch (e) {
                toast('Failed to clear user', 'error');
            }
        }
        
        // Banned
        async function loadBanned() {
            try {
                allUsers = await api('GET', 'users?order=banned_at.desc');
                const banned = allUsers.filter(u => u.status === 'banned');
                renderBanned(banned);
            } catch (e) {
                toast('Failed to load banned users', 'error');
            }
        }
        
        function renderBanned(list) {
            const rows = list.map(u => `<tr>
                <td><span class="app-id" onclick="viewUser('${u.app_id}')">${u.app_id}</span></td>
                <td>${u.license_key ? `<span class="license-key">${u.license_key}</span>` : '-'}</td>
                <td>${u.ban_reason || '-'}</td>
                <td>${formatDate(u.banned_at)}</td>
                <td>${u.last_ip || '-'}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-success" onclick="unbanUser('${u.app_id}')"><i class="bi bi-check-lg"></i> Unban</button>
                </td>
            </tr>`).join('');
            
            document.getElementById('bannedTable').innerHTML = rows || '<tr><td colspan="6"><div class="empty-state"><i class="bi bi-shield-check"></i><p>No banned users</p></div></td></tr>';
        }
        
        // Logs
        async function loadLogs() {
            try {
                allLogs = await api('GET', 'activity_logs?order=timestamp.desc&limit=500');
                renderLogs(allLogs);
            } catch (e) {
                // Table might not exist
                document.getElementById('logsTable').innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="bi bi-journal-x"></i><p>Activity logs table not found</p></div></td></tr>';
            }
        }
        
        function renderLogs(list) {
            const rows = list.map(l => {
                const actionColors = {
                    'validate': 'var(--accent-blue)',
                    'activate': 'var(--accent-green)',
                    'deactivate': 'var(--accent-yellow)',
                    'failed': 'var(--accent-red)'
                };
                const color = actionColors[l.action] || 'var(--text-secondary)';
                
                return `<tr>
                    <td>${formatDate(l.timestamp)}</td>
                    <td><span style="color:${color};font-weight:500;">${l.action}</span></td>
                    <td>${l.license_key ? `<span class="license-key">${l.license_key}</span>` : '-'}</td>
                    <td>${l.app_id ? `<span class="app-id">${l.app_id.slice(0,12)}...</span>` : '-'}</td>
                    <td>${l.ip || '-'}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.details || ''}">${l.details || '-'}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('logsTable').innerHTML = rows || '<tr><td colspan="6"><div class="empty-state"><i class="bi bi-journal"></i><p>No activity logs</p></div></td></tr>';
        }
        
        function filterLogs() {
            const q = document.getElementById('logSearchInput').value.toLowerCase();
            const action = document.getElementById('filterLogAction').value;
            
            const filtered = allLogs.filter(l => {
                const matchSearch = !q || (l.license_key || '').toLowerCase().includes(q) || (l.app_id || '').toLowerCase().includes(q) || (l.ip || '').toLowerCase().includes(q);
                const matchAction = !action || l.action === action;
                return matchSearch && matchAction;
            });
            renderLogs(filtered);
        }
        
        async function clearLogs() {
            if (!confirm('Clear all activity logs? This cannot be undone.')) return;
            
            try {
                await api('DELETE', 'activity_logs?id=gt.0');
                toast('Logs cleared');
                loadLogs();
            } catch (e) {
                toast('Failed to clear logs', 'error');
            }
        }
    </script>
</body>
</html>
